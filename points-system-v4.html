<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Favicon links removed until files are deployed -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Manifest link removed until file is deployed -->
  <link rel="dns-prefetch" href="https://api.twitter.com">
  <link rel="preconnect" href="https://api.twitter.com" crossorigin>
  <title>Points System — WENDROPS</title>
  <meta name="description" content="Earn points and climb the leaderboard on WENDROPS. Complete daily quests and boost your airdrop eligibility.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
    // Reuse hardened ethers loader here too
    window.__ethersReady = (function() {
      if (window.__ethersReady) return window.__ethersReady;
      let resolveFn, rejectFn;
      const p = new Promise((res, rej) => { resolveFn = res; rejectFn = rej; });
      function load(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.crossOrigin = 'anonymous';
          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error('Failed: ' + src));
          document.head.appendChild(s);
        });
      }
      (async () => {
        if (window.ethers) { resolveFn(true); return; }
        const cdns = [
          'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js',
          'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
          'https://cdn.skypack.dev/ethers@5.7.2?min'
        ];
        const deadline = Date.now() + 15000;
        for (const url of cdns) {
          try {
            await load(url);
            if (window.ethers) { console.log('ethers loaded from', url); resolveFn(true); return; }
          } catch (e) { console.warn('ethers load failed', url); }
          if (Date.now() > deadline) break;
        }
        rejectFn(new Error('ethers failed to load'));
      })();
      return p;
    })();
  </script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script>
    // Force refresh cache
    if (performance.navigation.type === 1) {
      console.log('Page refreshed - cache cleared');
    }
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'crypto-gold': '#FFD700',
            'crypto-blue': '#00D4FF',
            'crypto-purple': '#8B5CF6',
            'dark-bg': '#0A0A0A',
            'dark-card': '#1A1A1A',
            'dark-border': '#2A2A2A'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
            'spin-slow': 'spin 3s linear infinite'
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 50%, #0A0A0A 100%);
      min-height: 100vh;
    }
    .glassmorphism {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-orb {
      background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, rgba(0, 212, 255, 0.1) 50%, transparent 70%);
    }
    /* Gatekeeping styles */
    body.gated > *:not(.gate-overlay) { filter: blur(10px) grayscale(15%); pointer-events: none; user-select: none; }
    .gate-overlay { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 24px; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
    .gate-card { max-width: 720px; width: 100%; border-radius: 20px; padding: 28px; text-align: center; background: linear-gradient(135deg, rgba(17,24,39,0.96), rgba(2,6,23,0.96)); color: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.45), inset 0 0 40px rgba(99,102,241,0.25); border: 1px solid rgba(99,102,241,0.35); }
    .gate-title { font-size: 28px; font-weight: 800; letter-spacing: .5px; margin-bottom: 10px; }
    .gate-sub { font-size: 16px; opacity: .9; margin-bottom: 18px; }
    .gate-pill { display: inline-block; padding: 8px 14px; border-radius: 9999px; background: linear-gradient(90deg, #22d3ee, #a78bfa); color: #0b1020; font-weight: 700; font-size: 14px; }
  </style>
</head>
<body class="dark bg-dark-bg text-white">
  <div class="gate-overlay">
    <div class="gate-card">
      <div class="gate-pill">Coming soon</div>
      <div class="gate-title">Stay tuned!! Devs are cooking something up!!</div>
      <div class="gate-sub">A sneak peek is live — the full Points System unlocks shortly. Check back soon.</div>
      <a href="index.html" class="inline-flex items-center justify-center mt-2 px-4 py-2 rounded-lg font-semibold bg-white text-black hover:bg-white/90 transition">
        ← Back to Home
      </a>
    </div>
  </div>
  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <!-- Floating Points Widget -->
  <div id="floatingPointsWidget" class="fixed top-4 right-4 z-50 bg-crypto-purple text-white px-4 py-2 rounded-lg shadow-lg font-bold text-lg hidden">
    <span id="userPointsDisplay">0</span> Points
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-black/40 backdrop-blur-xl border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <img src="/favicon-96x96.png?v=1" alt="WENDROPS" class="w-8 h-8 rounded-lg shadow-glow" />
          <h1 class="text-lg sm:text-xl font-semibold tracking-tight">WENDROPS</h1>
          <span class="ml-2 text-xs text-white/50">Pro</span>
        </div>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <a href="index.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Home</a>
        <a href="wallet-analysis-v4.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Wallet Analysis</a>
        <a href="points-system-v4.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Points System</a>
        <a href="terms.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Terms</a>
        <button id="toggleTheme" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition ml-1 text-white/80">Toggle Theme</button>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-crypto-gold via-crypto-blue to-crypto-purple bg-clip-text text-transparent">
        Points System
      </h1>
      <p class="text-xl text-gray-300 mb-8">Earn points, complete quests, and boost your airdrop eligibility</p>
    </div>

    <!-- Points Overview -->
    <div class="grid md:grid-cols-3 gap-6 mb-12">
      <div class="glassmorphism rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-crypto-gold mb-2" id="totalPoints">0</div>
        <div class="text-gray-300">Total Points</div>
      </div>
      <div class="glassmorphism rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-crypto-blue mb-2" id="dailyPoints">0</div>
        <div class="text-gray-300">Daily Points</div>
      </div>
      <div class="glassmorphism rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-crypto-purple mb-2" id="rank">#1</div>
        <div class="text-gray-300">Your Rank</div>
      </div>
    </div>

    <!-- Wallet Connection -->
    <div class="glassmorphism rounded-xl p-8 mb-12">
      <h2 class="text-2xl font-bold mb-6 text-center">Connect Your Wallet</h2>
      <div class="text-center flex items-center justify-center gap-3">
        <button id="connectWalletBtn" class="bg-gradient-to-r from-crypto-purple to-crypto-blue text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all transform hover:scale-105">
          Connect Wallet
        </button>
        <button id="disconnectWalletBtn" class="px-4 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-semibold hidden">
          Disconnect
        </button>
      </div>
      <div class="text-center mt-4">
        <appkit-button></appkit-button>
      </div>
      <p class="text-gray-400 mt-4 text-center">Connect to start earning points and completing quests</p>
    </div>

    <!-- Daily Quests -->
    <div class="glassmorphism rounded-xl p-8 mb-12">
      <h2 class="text-2xl font-bold mb-6 text-center">Daily Quests</h2>
      <div id="dailyQuests" class="space-y-4">
        <!-- Quests will be populated by JavaScript -->
      </div>
    </div>

    <!-- X Integration -->
    <div class="glassmorphism rounded-xl p-8 mb-12">
      <h2 class="text-2xl font-bold mb-6 text-center">X (Twitter) Integration</h2>
      <div class="text-center">
        <div class="flex items-center justify-center gap-3">
          <button id="connectXBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all transform hover:scale-105">
          Connect X Account
          </button>
          <button id="disconnectXBtn" class="px-4 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-semibold hidden">
            Remove X Connection
          </button>
        </div>
        <p class="text-gray-400 mt-4">Connect your X account to complete social quests</p>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="glassmorphism rounded-xl p-8">
      <h2 class="text-2xl font-bold mb-6 text-center">Leaderboard</h2>
      <div id="leaderboard" class="space-y-4">
        <!-- Leaderboard will be populated by JavaScript -->
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-dark-card/80 backdrop-blur-md border-t border-dark-border mt-16">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center text-gray-400">
        <p>&copy; 2025 WENDROPS. All rights reserved.</p>
        <p class="mt-2">Discover, track, and participate in the best crypto airdrops.</p>
      </div>
    </div>
  </footer>

  <!-- Wallet Selection Modal -->
  <div id="walletModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glassmorphism rounded-xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-6 text-center">Select Wallet</h3>
      <div class="space-y-4">
        <button class="wallet-option w-full flex items-center space-x-4 p-4 rounded-lg bg-dark-border hover:bg-crypto-purple transition-colors" data-wallet="metamask">
          <span class="text-2xl">🦊</span>
          <span class="font-medium">MetaMask</span>
        </button>
        <button id="rabbyBtn" class="wallet-option w-full flex items-center space-x-4 p-4 rounded-lg bg-dark-border hover:bg-crypto-purple transition-colors" data-wallet="rabby">
          <span class="text-2xl">🦝</span>
          <span class="font-medium">Rabby</span>
        </button>
        <button class="wallet-option w-full flex items-center space-x-4 p-4 rounded-lg bg-dark-border hover:bg-crypto-purple transition-colors" data-wallet="walletconnect">
          <span class="text-2xl">🔗</span>
          <span class="font-medium">WalletConnect</span>
        </button>
      </div>
      <button id="closeWalletModal" class="w-full mt-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
        Cancel
      </button>
    </div>
  </div>

  <script type="module">
    // WalletConnect integration removed due to CORS issues
    // Using native injected wallet detection only
  </script>
  <script>
    // Global state
    let userData = {
      points: 0,
      dailyPoints: 0,
      rank: 1,
      walletConnected: false,
      walletType: null,
      walletAddress: null,
      xConnected: false
    };

    let walletProvider = null;
    let walletConnectProvider = null;

    // Points configuration
    const POINTS_CONFIG = {
      dailyQuests: [
        { id: 'visit', title: 'Visit Daily', description: 'Visit the platform', points: 10, completed: false },
        { id: 'wallet', title: 'Connect Wallet', description: 'Connect your wallet', points: 25, completed: false },
        { id: 'x_follow', title: 'Follow on X', description: 'Follow @AirdropHub on X', points: 50, completed: false },
        { id: 'share', title: 'Share Airdrop', description: 'Share an airdrop on social media', points: 30, completed: false }
      ],
      multipliers: {
        wallet: 1.2,
        x: 1.5,
        premium: 2.0
      }
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // Activate gate blur
      document.body.classList.add('gated');
      loadUserData();
      updateUserInterface();
      initializeDailyQuests();
      initializeEventListeners();
      initializeTheme();
      refreshXStatus();
    });

    // Load user data from localStorage
    function loadUserData() {
      const saved = localStorage.getItem('airdropHubUserData');
      if (saved) {
        userData = { ...userData, ...JSON.parse(saved) };
      }
    }

    // Save user data to localStorage (core)
    function saveUserDataCore() {
      localStorage.setItem('airdropHubUserData', JSON.stringify(userData));
    }
    // Backward-compatible wrapper used by older handlers
    function saveUserData() {
      saveUserDataCore();
    }

    // Update the user interface
    function updateUserInterface() {
      document.getElementById('totalPoints').textContent = userData.points;
      document.getElementById('dailyPoints').textContent = userData.dailyPoints;
      document.getElementById('rank').textContent = `#${userData.rank}`;
      document.getElementById('userPointsDisplay').textContent = userData.points;

      // Show/hide floating points widget
      const floatingWidget = document.getElementById('floatingPointsWidget');
      if (userData.points > 0) {
        floatingWidget.classList.remove('hidden');
      } else {
        floatingWidget.classList.add('hidden');
      }

      // Update wallet info
      const connectBtn = document.getElementById('connectWalletBtn');
      const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
      
      if (connectBtn) {
        if (userData.walletConnected) {
          connectBtn.textContent = 'Wallet Connected';
          connectBtn.disabled = true;
          connectBtn.classList.add('bg-green-600', 'cursor-not-allowed');
          connectBtn.classList.remove('from-crypto-purple', 'to-crypto-blue', 'hover:shadow-lg', 'hover:scale-105');
          if (disconnectWalletBtn) disconnectWalletBtn.classList.remove('hidden');
        } else {
          connectBtn.textContent = 'Connect Wallet';
          connectBtn.disabled = false;
          connectBtn.classList.remove('bg-green-600', 'cursor-not-allowed');
          connectBtn.classList.add('from-crypto-purple', 'to-crypto-blue', 'hover:shadow-lg', 'hover:scale-105');
          if (disconnectWalletBtn) disconnectWalletBtn.classList.add('hidden');
        }
      }

      // Update X connection
      const xBtn = document.getElementById('connectXBtn');
      if (userData.xConnected) {
        xBtn.textContent = 'X Connected';
        xBtn.disabled = true;
        xBtn.classList.add('bg-green-600', 'cursor-not-allowed');
        xBtn.classList.remove('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
      } else {
        xBtn.textContent = 'Connect X Account';
        xBtn.disabled = false;
        xBtn.classList.remove('bg-green-600', 'cursor-not-allowed');
        xBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
      }
    }

    // Initialize daily quests
    function initializeDailyQuests() {
      const questsContainer = document.getElementById('dailyQuests');
      questsContainer.innerHTML = '';

      POINTS_CONFIG.dailyQuests.forEach(quest => {
        const questElement = document.createElement('div');
        questElement.className = `glassmorphism rounded-lg p-4 ${quest.completed ? 'opacity-50' : ''}`;
        questElement.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-lg">${quest.title}</h3>
              <p class="text-gray-400">${quest.description}</p>
            </div>
        <div class="text-right">
          <div class="text-crypto-gold font-bold">+${quest.points} pts</div>
          ${quest.id === 'x_follow' && !quest.completed ? '<button id="btnFollowX" class="mt-2 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm">Verify Follow</button>' : ''}
          ${quest.completed ? '<div class="text-green-400 text-sm">✓ Completed</div>' : ''}
        </div>
          </div>
        `;
        questsContainer.appendChild(questElement);
      });

      // Wire follow verification button if present
      const btn = document.getElementById('btnFollowX');
      if (btn) {
        btn.addEventListener('click', async () => {
          await verifyFollowQuest();
          saveUserData();
          submitScoreAfterSave();
        });
      }
    }

    // Initialize event listeners
    function initializeEventListeners() {
      // Wallet connection
      const connectWalletBtn = document.getElementById('connectWalletBtn');
      if (connectWalletBtn) {
        connectWalletBtn.addEventListener('click', () => {
          connectWalletBtn.disabled = true;
          const prev = connectWalletBtn.textContent;
          connectWalletBtn.textContent = 'Opening…';
          openWalletModal();
          setTimeout(()=>{ connectWalletBtn.disabled = false; connectWalletBtn.textContent = prev; }, 800);
        });
      }
      
      const closeWalletModalBtn = document.getElementById('closeWalletModal');
      if (closeWalletModalBtn) {
        closeWalletModalBtn.addEventListener('click', closeWalletModal);
      }
      
      const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
      if (disconnectWalletBtn) {
        disconnectWalletBtn.addEventListener('click', () => {
          disconnectWallet();
          updateUserInterface();
        });
      }

      // Wallet options
      document.querySelectorAll('.wallet-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const walletType = e.currentTarget.dataset.wallet;
          connectWallet(walletType);
        });
      });

      // X connection
      const connectXBtn = document.getElementById('connectXBtn');
      if (connectXBtn) {
        connectXBtn.addEventListener('click', async () => {
          const prev = connectXBtn.textContent;
          connectXBtn.textContent = 'Connecting…';
          connectXBtn.disabled = true;
          try {
            await connectX();
          } finally {
            connectXBtn.textContent = prev;
            connectXBtn.disabled = false;
          }
        });
      }
      
      const disconnectXBtn = document.getElementById('disconnectXBtn');
      if (disconnectXBtn) {
        disconnectXBtn.addEventListener('click', disconnectX);
      }
    }

    // Initialize theme
    function initializeTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      if (!themeToggle) return;
      
      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.classList.toggle('dark', savedTheme === 'dark');
      
      themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    }

    // Wallet modal functions
    function openWalletModal() {
      document.getElementById('walletModal').classList.remove('hidden');
    }

    function closeWalletModal() {
      document.getElementById('walletModal').classList.add('hidden');
    }

    // Connect wallet
    async function connectWallet(walletType) {
      try {
        closeWalletModal();
        
        switch(walletType) {
          case 'metamask':
            await connectMetaMask();
            break;
          case 'walletconnect':
            await connectWalletConnect();
            break;
          case 'coinbase':
            await connectCoinbase();
            break;
          case 'trust':
            await connectTrust();
            break;
          case 'okx':
            await connectOKX();
            break;
          case 'phantom':
            await connectPhantom();
            break;
        }
      } catch (error) {
        console.error('Wallet connection failed:', error);
        alert('Wallet connection failed. Please try again.');
      }
    }

    // MetaMask connection
    async function connectMetaMask() {
      if (typeof window.ethereum !== 'undefined' && (window.ethereum.isMetaMask || window.ethereum.providers)) {
        const provider = window.ethereum.providers ? window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum : window.ethereum;
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userData.walletConnected = true;
        userData.walletType = 'MetaMask';
        userData.walletAddress = accounts[0];
        walletProvider = provider;
        
        // Complete wallet quest
        completeQuest('wallet');
        updateUserInterface();
        saveUserDataCore();
        submitScoreAfterSave();
        // Analytics event: wallet_connect
        try { window.va && window.va('event', { name: 'wallet_connect', params: { type: 'metamask' } }); } catch {}
      } else {
        alert('MetaMask not detected. Please install MetaMask or enable it in your browser.');
        throw new Error('MetaMask not installed');
      }
    }

    // WalletConnect connection
    async function connectWalletConnect() {
      const WC = (window.WalletConnectProvider && window.WalletConnectProvider.default) ? window.WalletConnectProvider.default : window.WalletConnectProvider;
      if (typeof WC !== 'undefined') {
        walletConnectProvider = new WC({
          rpc: {
            1: 'https://cloudflare-eth.com',
            137: 'https://polygon-rpc.com',
            56: 'https://bsc.publicnode.com'
          }
        });
        
        await walletConnectProvider.enable();
        const accounts = walletConnectProvider.accounts;
        
        userData.walletConnected = true;
        userData.walletType = 'WalletConnect';
        userData.walletAddress = accounts[0];
        walletProvider = walletConnectProvider;
        
        completeQuest('wallet');
        updateUserInterface();
        saveUserDataCore();
        submitScoreAfterSave();
        try { window.va && window.va('event', { name: 'wallet_connect', params: { type: 'walletconnect' } }); } catch {}
      } else {
        alert('WalletConnect provider not available');
        throw new Error('WalletConnect not available');
      }
    }

    // Coinbase connection
    async function connectCoinbase() {
      if (typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet) {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userData.walletConnected = true;
        userData.walletType = 'Coinbase';
        userData.walletAddress = accounts[0];
        walletProvider = window.ethereum;
        
        completeQuest('wallet');
        updateUserInterface();
        saveUserDataCore();
        submitScoreAfterSave();
      } else {
        throw new Error('Coinbase Wallet not available');
      }
    }

    // Trust Wallet connection
    async function connectTrust() {
      if (typeof window.ethereum !== 'undefined' && window.ethereum.isTrust) {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userData.walletConnected = true;
        userData.walletType = 'Trust';
        userData.walletAddress = accounts[0];
        walletProvider = window.ethereum;
        
        completeQuest('wallet');
        updateUserInterface();
        saveUserData();
      } else {
        throw new Error('Trust Wallet not available');
      }
    }

    // OKX Wallet connection
    async function connectOKX() {
      // Support both OKX's dedicated object and the unified ethereum provider flag
      const okxEth = (typeof window.okxwallet !== 'undefined' && window.okxwallet.ethereum)
        ? window.okxwallet.ethereum
        : (window.ethereum && (window.ethereum.isOkxWallet || window.ethereum.isOKExWallet) ? window.ethereum : null);

      if (!okxEth) {
        alert('OKX Wallet not detected. Please install/enable the OKX Wallet extension.');
        throw new Error('OKX Wallet not installed');
      }

      const accounts = await okxEth.request({ method: 'eth_requestAccounts' });
      userData.walletConnected = true;
      userData.walletType = 'OKX';
      userData.walletAddress = accounts[0];
      walletProvider = okxEth;

      completeQuest('wallet');
      updateUserInterface();
      saveUserDataCore();
      submitScoreAfterSave();
    }

    // Phantom connection
    async function connectPhantom() {
      if (typeof window.phantom !== 'undefined' && window.phantom.solana) {
        const response = await window.phantom.solana.connect();
        userData.walletConnected = true;
        userData.walletType = 'Phantom';
        userData.walletAddress = response.publicKey.toString();
        walletProvider = window.phantom.solana;
        
        completeQuest('wallet');
        updateUserInterface();
        saveUserData();
      } else {
        throw new Error('Phantom not installed');
      }
    }

    // Disconnect wallet
    function disconnectWallet() {
      userData.walletConnected = false;
      userData.walletType = null;
      userData.walletAddress = null;
      walletProvider = null;
      walletConnectProvider = null;
      
      updateUserInterface();
      saveUserData();
    }

    // Connect X
    async function connectX() {
      try {
        // Redirect to X OAuth
        window.location.href = '/api/x/login';
        try { window.va && window.va('event', { name: 'x_connect' }); } catch {}
      } catch (error) {
        console.error('X connection failed:', error);
        alert('X connection failed. Please try again.');
      }
    }

    // Verify follow quest using real API (requires X connection)
    async function verifyFollowQuest() {
      try {
        const res = await fetch('/api/x/status', { credentials: 'include' });
        const { connected } = await res.json();
        if (!connected) {
          showNotification('Please connect X first', 'error');
          return;
        }
        const targetUsername = 'wendrops_com';
        const v = await fetch('/api/twitter/verify-follow-real', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ targetUsername })
        });
        const data = await v.json();
        if (!v.ok) {
          showNotification(data?.error || 'Verification failed', 'error');
          return;
        }
        if (data.isFollowing) {
          completeQuest('x_follow');
          showNotification('Follow verified', 'success');
          try { window.va && window.va('event', { name: 'quest_verify', params: { quest: 'x_follow', result: 'success' } }); } catch {}
        } else {
          showNotification('You are not following yet', 'info');
          try { window.va && window.va('event', { name: 'quest_verify', params: { quest: 'x_follow', result: 'not_following' } }); } catch {}
        }
      } catch (e) {
        showNotification('Verification failed', 'error');
        try { window.va && window.va('event', { name: 'quest_verify', params: { quest: 'x_follow', result: 'error' } }); } catch {}
      }
    }

    // Refresh X connection status from server
    async function refreshXStatus() {
      try {
        const res = await fetch('/api/x/status', { credentials: 'include' });
        const data = await res.json();
        const xBtn = document.getElementById('connectXBtn');
        const dxBtn = document.getElementById('disconnectXBtn');
        if (data.connected) {
          xBtn.textContent = data.user?.username ? `X Connected (@${data.user.username})` : 'X Connected';
          xBtn.disabled = true;
          xBtn.classList.add('bg-green-600', 'cursor-not-allowed');
          xBtn.classList.remove('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
          dxBtn.classList.remove('hidden');
        } else {
          xBtn.textContent = 'Connect X Account';
          xBtn.disabled = false;
          xBtn.classList.remove('bg-green-600', 'cursor-not-allowed');
          xBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
          dxBtn.classList.add('hidden');
        }
      } catch (e) {
        console.warn('Status check failed', e);
        // Force reset to disconnected state on error
        const xBtn = document.getElementById('connectXBtn');
        const dxBtn = document.getElementById('disconnectXBtn');
        if (xBtn) {
          xBtn.textContent = 'Connect X Account';
          xBtn.disabled = false;
          xBtn.classList.remove('bg-green-600', 'cursor-not-allowed');
          xBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
        }
        if (dxBtn) {
          dxBtn.classList.add('hidden');
        }
      }
    }

  // Periodically refresh X token if refresh cookie exists
  setInterval(async () => {
    try {
      // lightweight ping to check cookie presence via status (includes cookies)
      const res = await fetch('/api/x/status', { credentials: 'include' });
      const data = await res.json();
      if (data && data.connected) {
        // attempt refresh silently
        await fetch('/api/x/refresh', { method: 'POST', credentials: 'include' });
      }
    } catch {}
  }, 10 * 60 * 1000);

    // Disconnect X and refresh UI
    async function disconnectX() {
      try {
        await fetch('/api/x/logout', { method: 'POST', credentials: 'include' });
        // Force immediate UI update
        const xBtn = document.getElementById('connectXBtn');
        const dxBtn = document.getElementById('disconnectXBtn');
        if (xBtn) {
          xBtn.textContent = 'Connect X Account';
          xBtn.disabled = false;
          xBtn.classList.remove('bg-green-600', 'cursor-not-allowed');
          xBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:shadow-lg', 'hover:scale-105');
        }
        if (dxBtn) {
          dxBtn.classList.add('hidden');
        }
        await refreshXStatus();
        showNotification('Disconnected from X', 'info');
      } catch (e) {
        showNotification('Failed to disconnect', 'error');
      }
    }

    // Complete quest
    function completeQuest(questId) {
      const quest = POINTS_CONFIG.dailyQuests.find(q => q.id === questId);
      if (quest && !quest.completed) {
        quest.completed = true;
        userData.points += quest.points;
        userData.dailyPoints += quest.points;
        
        updateUserInterface();
        initializeDailyQuests();
        saveUserData();
        
        // Show notification
        showNotification(`Quest completed! +${quest.points} points`, 'success');
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 left-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      } text-white font-medium`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Initialize leaderboard
    async function initializeLeaderboard() {
      const el = document.getElementById('leaderboard');
      el.innerHTML = '<div class="text-center text-gray-400">Loading...</div>';
      try {
        const res = await fetch('/api/leaderboard', { cache: 'no-store' });
        const data = await res.json();
        const items = (data && data.data) ? data.data : [];
        el.innerHTML = '';
        if (items.length === 0) { el.innerHTML = '<div class="text-center text-gray-400">No entries yet</div>'; return; }
        items.forEach((user, idx) => {
          const userElement = document.createElement('div');
          userElement.className = 'flex items-center justify-between p-4 rounded-lg bg-dark-border';
          const name = user.username || (user.wallet ? user.wallet.slice(0,6)+'...'+user.wallet.slice(-4) : 'User');
          userElement.innerHTML = `
            <div class="flex items-center space-x-4">
              <div class="text-2xl font-bold text-crypto-gold">#${idx+1}</div>
              <div class="font-medium">${name}</div>
            </div>
            <div class="text-crypto-blue font-bold">${user.points} pts</div>
          `;
          el.appendChild(userElement);
        });
      } catch { el.innerHTML = '<div class="text-center text-red-400">Failed to load leaderboard</div>'; }
    }

    // Submit score helper (call after saveUserData when points change)
    function submitScoreAfterSave() {
      try {
        window.va && window.va('event', { name: 'leaderboard_submit', params: { points: userData.points } });
        fetch('/api/leaderboard/submit', {
          method: 'POST', headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ wallet: userData.walletAddress, points: userData.points, username: userData.walletType })
        }).then(()=>initializeLeaderboard());
      } catch {}
    }

    // Initialize leaderboard on load
    initializeLeaderboard();
  </script>
</script>
  <script defer src="/_vercel/insights/script.js"></script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>


