<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>Wallet Analysis - Airdrop Hub v3.0 (Real Blockchain Data)</title>
  <meta name="description" content="Real blockchain wallet analysis across multiple networks for airdrop eligibility">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Force refresh cache
    if (performance.navigation.type === 1) {
      console.log('Page refreshed - cache cleared');
    }
    
    // Ensure ethers is loaded
    window.addEventListener('load', function() {
      const statusDiv = document.getElementById('libraryStatus');
      
      // Set a timeout to prevent infinite loading
      const timeout = setTimeout(() => {
        if (typeof ethers === 'undefined') {
          console.error('Ethers library loading timeout');
          statusDiv.textContent = 'Loading timeout. Please refresh the page.';
          statusDiv.classList.remove('hidden');
        }
      }, 10000); // 10 second timeout
      
      if (typeof ethers === 'undefined') {
        console.error('Ethers library failed to load, retrying...');
        statusDiv.classList.remove('hidden');
        statusDiv.textContent = 'Retrying blockchain library...';
        
        // Retry loading ethers
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
        script.onload = function() {
          console.log('Ethers library loaded successfully on retry');
          clearTimeout(timeout);
          statusDiv.classList.add('hidden');
        };
        script.onerror = function() {
          console.error('Failed to load ethers library, trying alternative CDN...');
          statusDiv.textContent = 'Trying alternative CDN...';
          
          // Try alternative CDN
          const altScript = document.createElement('script');
          altScript.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
          altScript.onload = function() {
            console.log('Ethers library loaded successfully from alternative CDN');
            clearTimeout(timeout);
            statusDiv.classList.add('hidden');
          };
          altScript.onerror = function() {
            console.error('All CDN attempts failed');
            clearTimeout(timeout);
            statusDiv.textContent = 'Failed to load blockchain library. Please refresh the page.';
            statusDiv.classList.remove('hidden');
          };
          document.head.appendChild(altScript);
        };
        document.head.appendChild(script);
      } else {
        console.log('Ethers library loaded successfully');
        clearTimeout(timeout);
        statusDiv.classList.add('hidden');
      }
    });
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
            }
          }
        }
      }
    }
  </script>
  <style>
    .form-input {
      @apply bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent;
    }
    .btn-primary {
      @apply bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl;
    }
    .loading-spinner {
      @apply border-4 border-white/20 border-t-blue-500 rounded-full animate-spin;
    }
  </style>
</head>
<body class="min-h-screen text-white relative overflow-x-hidden" style="background: linear-gradient(135deg, #0a0e1a 0%, #111827 100%);">
  <!-- Background Orbs / Grid -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-24 -right-16 w-[38rem] h-[38rem] rounded-full blur-3xl opacity-20" style="background: radial-gradient(circle at 30% 30%, rgba(59,130,246,0.6), transparent 60%);"></div>
    <div class="absolute -bottom-24 -left-16 w-[34rem] h-[34rem] rounded-full blur-3xl opacity-20" style="background: radial-gradient(circle at 70% 70%, rgba(16,185,129,0.5), transparent 60%);"></div>
    <div class="absolute inset-0 opacity-[0.06]" style="background-image: linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 24px 24px;"></div>
  </div>

  <header class="sticky top-0 z-40 bg-black/40 backdrop-blur-xl border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <a href="index.html" class="flex items-center gap-2 text-2xl font-bold text-white">
            <img src="/favicon.svg" alt="WENDROPS" class="w-8 h-8 rounded-lg shadow-glow" />
            <span>WENDROPS</span>
          </a>
          <nav class="hidden md:flex space-x-2 items-center">
            <a href="index.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Home</a>
            <a href="points-system.html" class="px-3 py-1.5 rounded-lg border border-white/10 hover:border-white/20 bg-white/5 hover:bg-white/10 transition">Points System</a>
            <a href="wallet-analysis.html" class="px-3 py-1.5 rounded-lg border border-white/20 bg-white/10">Wallet Analysis</a>
            <button id="toggleTheme" class="ml-2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition">Toggle Theme</button>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Floating Points Widget -->
    <div id="pointsWidget" class="hidden fixed right-4 bottom-4 z-40">
      <div class="rounded-xl border border-white/10 bg-black/50 backdrop-blur px-4 py-3 shadow-glow">
        <div class="text-xs text-white/60">Your Points</div>
        <div id="pointsWidgetValue" class="text-2xl font-bold">0</div>
        <div id="pointsWidgetAddr" class="text-[11px] text-white/50 mt-1">-</div>
      </div>
    </div>
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <h1 class="text-4xl sm:text-6xl font-bold text-white mb-4 bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
        Wallet Analysis
      </h1>
      
      <p class="text-lg text-white/70 max-w-2xl mx-auto">
        Get real blockchain data and insights about any wallet address across multiple networks.
      </p>
    </div>

    <!-- Analysis Form -->
    <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-8 border border-white/10 mb-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Chain Selection -->
        <div>
          <label class="block text-sm font-medium text-white mb-2">Select Chain</label>
          <select id="chainSelect" class="form-input w-full p-3">
            <option value="ethereum">Ethereum</option>
            <option value="base">Base</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="polygon">Polygon</option>
            <option value="avalanche">Avalanche</option>
            <option value="bsc">BSC</option>
            <option value="optimism">Optimism</option>
            <option value="fantom">Fantom</option>
          </select>
        </div>

        <!-- Address Input -->
        <div>
          <label class="block text-sm font-medium text-white mb-2">Wallet Address</label>
          <input 
            type="text" 
            id="walletAddress" 
            placeholder="0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6"
            class="form-input w-full p-3"
          >
        </div>
      </div>

      <div class="mt-6 text-center">
        <button id="analyzeBtn" class="btn-primary px-8 py-3 text-lg">
          Analyze Wallet
        </button>
        <div id="libraryStatus" class="mt-2 text-sm text-white/60 hidden">
          Loading blockchain library...
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden text-center py-12">
      <div class="loading-spinner w-12 h-12 mx-auto mb-4"></div>
      <p class="text-white/70">Fetching real blockchain data...</p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-8">
      <!-- Wallet Overview -->
      <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-2xl font-bold text-white mb-6">Wallet Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-400" id="walletBalance">0 ETH</div>
            <div class="text-sm text-white/60">Native Balance</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-400" id="transactionCount">0</div>
            <div class="text-sm text-white/60">Total Transactions</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-400" id="lastActivity">-</div>
            <div class="text-sm text-white/60">Last Activity</div>
          </div>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-2xl font-bold text-white mb-6">Recent Transactions</h2>
        <div id="transactionList" class="space-y-3">
          <!-- Transactions will be populated here -->
        </div>
      </div>

      <!-- Airdrop Eligibility -->
      <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-2xl font-bold text-white mb-6">Airdrop Eligibility Score</h2>
        <div class="text-center">
          <div class="text-6xl font-bold text-yellow-400 mb-4" id="eligibilityScore">0%</div>
          <div class="w-full bg-white/10 rounded-full h-4 mb-4">
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-4 rounded-full transition-all duration-1000" id="eligibilityBar" style="width: 0%"></div>
          </div>
          <p class="text-white/70" id="eligibilityText">Analyze wallet to see eligibility score</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Light mode inversion hack
    (function(){
      const style = document.createElement('style');
      style.textContent = `html.light { filter: invert(1) hue-rotate(180deg); } html.light img, html.light video, html.light iframe { filter: invert(1) hue-rotate(180deg); }`;
      document.head.appendChild(style);
      try { const saved = localStorage.getItem('theme'); if (saved === 'light') document.documentElement.classList.add('light'); } catch {}
      const btn = document.getElementById('toggleTheme');
      if (btn) {
        btn.addEventListener('click', () => {
          const isLight = document.documentElement.classList.toggle('light');
          try { localStorage.setItem('theme', isLight ? 'light' : 'dark'); } catch {}
        });
      }
    })();

    // Floating points widget updater
    function updatePointsWidget() {
      try {
        const addr = localStorage.getItem('current_user_wallet');
        const w = document.getElementById('pointsWidget');
        if (!addr || !w) return;
        const user = JSON.parse(localStorage.getItem('user_' + addr) || '{}');
        const points = user.totalPoints ?? 0;
        const val = document.getElementById('pointsWidgetValue');
        const ad = document.getElementById('pointsWidgetAddr');
        if (val && ad) { val.textContent = String(points); ad.textContent = addr.slice(0,6)+'…'+addr.slice(-4); }
        w.classList.remove('hidden');
      } catch {}
    }
    window.addEventListener('storage', (e) => { if (!e.key) return; if (e.key.startsWith('user_') || e.key === 'current_user_wallet') updatePointsWidget(); });
    updatePointsWidget();
    // Real blockchain RPC endpoints
    const RPC_ENDPOINTS = {
      ethereum: 'https://eth.llamarpc.com',
      base: 'https://mainnet.base.org',
      arbitrum: 'https://arb1.arbitrum.io/rpc',
      polygon: 'https://polygon-rpc.com',
      avalanche: 'https://api.avax.network/ext/bc/C/rpc',
      bsc: 'https://bsc-dataseed.binance.org',
      optimism: 'https://mainnet.optimism.io',
      fantom: 'https://rpc.ftm.tools'
    };

    // Chain configurations
    const CHAIN_CONFIG = {
      ethereum: { name: 'Ethereum', symbol: 'ETH', decimals: 18, explorer: 'https://etherscan.io' },
      base: { name: 'Base', symbol: 'ETH', decimals: 18, explorer: 'https://basescan.org' },
      arbitrum: { name: 'Arbitrum', symbol: 'ETH', decimals: 18, explorer: 'https://arbiscan.io' },
      polygon: { name: 'Polygon', symbol: 'MATIC', decimals: 18, explorer: 'https://polygonscan.com' },
      avalanche: { name: 'Avalanche', symbol: 'AVAX', decimals: 18, explorer: 'https://snowtrace.io' },
      bsc: { name: 'BSC', symbol: 'BNB', decimals: 18, explorer: 'https://bscscan.com' },
      optimism: { name: 'Optimism', symbol: 'ETH', decimals: 18, explorer: 'https://optimistic.etherscan.io' },
      fantom: { name: 'Fantom', symbol: 'FTM', decimals: 18, explorer: 'https://ftmscan.com' }
    };

    // Etherscan-compatible API endpoints for recent transactions (supports CORS)
    const EXPLORER_API = {
      ethereum: 'https://api.etherscan.io/api',
      base: 'https://api.basescan.org/api',
      arbitrum: 'https://api.arbiscan.io/api',
      polygon: 'https://api.polygonscan.com/api',
      avalanche: 'https://api.snowtrace.io/api',
      bsc: 'https://api.bscscan.com/api',
      optimism: 'https://api-optimistic.etherscan.io/api',
      fantom: 'https://api.ftmscan.com/api'
    };

    let currentProvider = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('analyzeBtn').addEventListener('click', analyzeWallet);
    });

    // Validate Ethereum address
    function isValidAddress(address) {
      return /^0x[a-fA-F0-9]{40}$/.test(address);
    }

    // Format address
    function formatAddress(address) {
      return `${address.slice(0, 6)}...${address.slice(-4)}`;
    }

    // Format number
    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }

    // Format currency
    function formatCurrency(amount, symbol = 'USD') {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: symbol
      }).format(amount);
    }

    // Get provider for selected chain
    function getProvider(chain) {
      const rpcUrl = RPC_ENDPOINTS[chain];
      if (!rpcUrl) throw new Error(`Unsupported chain: ${chain}`);
      return new ethers.providers.JsonRpcProvider(rpcUrl);
    }

    // Analyze wallet
    async function analyzeWallet() {
      const address = document.getElementById('walletAddress').value.trim();
      const chain = document.getElementById('chainSelect').value;

      if (!address) {
        alert('Please enter a wallet address');
        return;
      }

      if (!isValidAddress(address)) {
        alert('Please enter a valid Ethereum address');
        return;
      }

      // Check if ethers is loaded
      if (typeof ethers === 'undefined') {
        alert('Blockchain library is still loading. Please wait a moment and try again.');
        return;
      }

      try {
        // Show loading
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');

        console.log('🔍 Starting real blockchain analysis...');
        console.log('Address:', address);
        console.log('Chain:', chain);
        console.log('Ethers available:', typeof ethers !== 'undefined');

        // Get provider
        currentProvider = getProvider(chain);
        const config = CHAIN_CONFIG[chain];

        console.log('📡 Fetching real blockchain data...');

        // Fetch real blockchain data
        const [balance, txCount, lastTx] = await Promise.all([
          getBalance(address, currentProvider),
          getTransactionCount(address, currentProvider),
          getLastTransaction(address, currentProvider, config.explorer)
        ]);

        console.log('✅ Real data fetched:', { balance, txCount, lastTx });

        // Calculate eligibility score
        const eligibilityScore = calculateEligibilityScore(balance, txCount);

        // Update UI with real data
        updateWalletOverview(balance, txCount, lastTx, config);
        updateEligibilityScore(eligibilityScore);
        await updateTransactionHistory(address, chain, config.explorer);

        // Show results
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('results').classList.remove('hidden');

        console.log('🎉 Analysis complete with REAL blockchain data!');

      } catch (error) {
        console.error('Analysis error:', error);
        alert(`Analysis failed: ${error.message}`);
        document.getElementById('loadingState').classList.add('hidden');
      }
    }

    // Get wallet balance
    async function getBalance(address, provider) {
      try {
        const balance = await provider.getBalance(address);
        return ethers.utils.formatEther(balance);
      } catch (error) {
        console.error('Balance fetch error:', error);
        return '0';
      }
    }

    // Get transaction count
    async function getTransactionCount(address, provider) {
      try {
        return await provider.getTransactionCount(address);
      } catch (error) {
        console.error('Transaction count error:', error);
        return 0;
      }
    }

    // Get last transaction (simplified)
    async function getLastTransaction(address, provider, explorer) {
      try {
        // This would require a more complex implementation with block scanning
        // For now, return a placeholder
        return 'Unknown';
      } catch (error) {
        console.error('Last transaction error:', error);
        return 'Unknown';
      }
    }

    // Calculate eligibility score based on real data
    function calculateEligibilityScore(balance, txCount) {
      const balanceNum = parseFloat(balance);
      const txNum = parseInt(txCount);

      let score = 0;

      // Balance scoring (0-40 points)
      if (balanceNum > 10) score += 40;
      else if (balanceNum > 5) score += 30;
      else if (balanceNum > 1) score += 20;
      else if (balanceNum > 0.1) score += 10;

      // Transaction activity scoring (0-60 points)
      if (txNum > 1000) score += 60;
      else if (txNum > 500) score += 50;
      else if (txNum > 100) score += 40;
      else if (txNum > 50) score += 30;
      else if (txNum > 10) score += 20;
      else if (txNum > 0) score += 10;

      return Math.min(100, score);
    }

    // Update wallet overview
    function updateWalletOverview(balance, txCount, lastTx, config) {
      document.getElementById('walletBalance').textContent = `${parseFloat(balance).toFixed(4)} ${config.symbol}`;
      document.getElementById('transactionCount').textContent = formatNumber(txCount);
      document.getElementById('lastActivity').textContent = lastTx;
    }

    // Update eligibility score
    function updateEligibilityScore(score) {
      document.getElementById('eligibilityScore').textContent = `${score}%`;
      document.getElementById('eligibilityBar').style.width = `${score}%`;
      
      let text = '';
      if (score >= 80) text = 'Excellent! High airdrop eligibility';
      else if (score >= 60) text = 'Good! Moderate airdrop eligibility';
      else if (score >= 40) text = 'Fair. Consider more activity';
      else if (score >= 20) text = 'Low. Increase wallet activity';
      else text = 'Very low. Start using DeFi more';
      
      document.getElementById('eligibilityText').textContent = text;
    }

    // Fetch recent transactions via Etherscan-compatible APIs
    async function fetchRecentTransactions(address, chain) {
      try {
        const apiBase = EXPLORER_API[chain];
        if (!apiBase) throw new Error('Unsupported chain for explorer API');

        // Optional: Allow API key via localStorage (per-chain) or global
        const chainKey = (localStorage.getItem(`apiKey_${chain}`) || '').trim();
        const globalKey = (localStorage.getItem('ETHERSCAN_API_KEY') || '').trim();
        const apiKey = chainKey || globalKey; // safe to be empty

        const params = new URLSearchParams({
          module: 'account',
          action: 'txlist',
          address: address,
          startblock: '0',
          endblock: '99999999',
          page: '1',
          offset: '10',
          sort: 'desc'
        });
        if (apiKey) params.append('apikey', apiKey);

        const url = `${apiBase}?${params.toString()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Explorer API request failed');
        const data = await res.json();
        if (data.status !== '1' || !Array.isArray(data.result)) {
          throw new Error(data.message || 'No transactions found');
        }
        return data.result;
      } catch (err) {
        console.warn('fetchRecentTransactions failed:', err.message);
        return [];
      }
    }

    // Update transaction history UI (with graceful fallback)
    async function updateTransactionHistory(address, chain, explorer) {
      const container = document.getElementById('transactionList');
      container.innerHTML = '<div class="text-white/60">Loading recent transactions...</div>';

      const txs = await fetchRecentTransactions(address, chain);
      if (!txs || txs.length === 0) {
        container.innerHTML = `
          <div class="text-center text-white/70 py-4">
            <p>No recent transactions available from API.</p>
            <p class="text-sm mt-2">
              <a href="${explorer}/address/${address}" target="_blank" class="text-blue-400 hover:text-blue-300">
                View full history on explorer
              </a>
            </p>
          </div>
        `;
        return;
      }

      // Render list
      container.innerHTML = '';
      txs.forEach(tx => {
        const isOutgoing = tx.from?.toLowerCase() === address.toLowerCase();
        const valueEth = Number(ethers.utils.formatEther(tx.value || '0'));
        const time = tx.timeStamp ? new Date(Number(tx.timeStamp) * 1000) : null;
        const item = document.createElement('a');
        item.href = `${explorer}/tx/${tx.hash}`;
        item.target = '_blank';
        item.className = 'block p-4 bg-white/5 rounded-xl border border-white/10 hover:bg-white/10 transition-colors';
        item.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="min-w-0">
              <div class="text-white font-semibold truncate">${tx.hash}</div>
              <div class="text-xs text-white/50 mt-1 truncate">${isOutgoing ? 'Sent' : 'Received'} • From ${formatAddress(tx.from)} to ${formatAddress(tx.to || '0x')}</div>
            </div>
            <div class="text-right ml-4">
              <div class="${isOutgoing ? 'text-red-400' : 'text-green-400'} font-semibold">${isOutgoing ? '-' : '+'}${valueEth.toFixed(6)}</div>
              <div class="text-xs text-white/50">${time ? time.toLocaleString() : ''}</div>
            </div>
          </div>
        `;
        container.appendChild(item);
      });
    }
  </script>
</body>
</html>
